<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قاعدة بيانات الناخبين المشتركة (Firebase Firestore)</title>
    <style>
        /* الخط العام والتنسيقات الأساسية */
        body { 
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #eef2f5; /* لون خلفية خفيف */
            padding: 30px; 
            direction: rtl; 
            text-align: right; 
            color: #333;
        }

        /* حاويات ومكونات */
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* ظل أكثر وضوحاً */
        }

        h1 {
            text-align: center;
            color: #1a73e8; /* لون أزرق عصري */
            border-bottom: 3px solid #1a73e8;
            padding-bottom: 12px;
            margin-bottom: 40px;
            font-weight: 700;
        }
        
        h2 {
            color: #3c4043;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        /* تنسيق النماذج وحقول الإدخال والأزرار */
        #voterForm {
            display: flex;
            flex-wrap: wrap; /* للسماح بتنسيق جيد على الشاشات الصغيرة */
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background-color: #f7f9fc;
        }

        #voterForm input {
            flex: 1 1 200px; /* مرونة في الحجم */
            min-width: 150px; /* ضمان أن تكون الحقول واضحة */
        }
        
        #searchSection {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
        }

        input[type="text"] {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px; /* حواف أكثر استدارة */
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input[type="text"]:focus {
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
            outline: none;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* أزرار الإجراءات */
        button[type="submit"] { background-color: #34a853; } /* أخضر جوجل */
        button[type="submit"]:hover { background-color: #279d45; }
        .edit-btn { background-color: #fbbc04; color: #333; } /* أصفر جوجل */
        .edit-btn:hover { background-color: #e0a800; }
        .delete-btn { background-color: #ea4335; } /* أحمر جوجل */
        .delete-btn:hover { background-color: #d13226; }
        .save-btn { background-color: #4285f4; } /* أزرق جوجل */
        .save-btn:hover { background-color: #357ae8; }
        .cancel-btn { background-color: #9aa0a6; }
        .cancel-btn:hover { background-color: #7d8186; }

        /* الجدول */
        #votersTable {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        #votersTable th, #votersTable td { 
            padding: 15px; 
            text-align: right; 
            border-bottom: 1px solid #e8e8e8;
            /* للتأكد من انطباق الترتيب الجديد */
            white-space: nowrap; /* منع التفاف النصوص في الجدول */
        }

        #votersTable th { 
            background-color: #1a73e8; 
            color: white; 
            font-weight: 700;
            text-transform: uppercase;
        }

        #votersTable tbody tr:nth-child(even) {
            background-color: #f7f9fc;
        }
        
        #votersTable tbody tr:hover {
            background-color: #e6f4f1; /* لون فاتح عند المرور بالماوس */
        }

        /* الرسائل */
        .message { padding: 12px; margin-top: 15px; border-radius: 8px; font-weight: bold; text-align: center; }
        .success { background-color: #e6f4ea; color: #1e8e3e; border: 1px solid #c2e8c2; }
        .error { background-color: #fce8e6; color: #d93025; border: 1px solid #f4c7c3; }

        /* تنسيق خاص للخلايا في وضع التعديل */
        .editing-cell input {
            width: 95%; 
            padding: 8px; 
            margin: 0; 
            box-sizing: border-box;
            border-radius: 4px;
        }

        /* استجابة الأبعاد */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            #voterForm { flex-direction: column; align-items: stretch; }
            #voterForm input { flex: none; width: 100%; }
            button { width: 100%; margin-top: 5px; }
            #votersTable th, #votersTable td { padding: 8px; font-size: 14px; }
            /* إخفاء بعض الأعمدة غير الضرورية على الجوال لضمان عدم وجود سكرول أفقي */
            .hide-on-mobile { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>إدارة قاعدة بيانات الناخبين المشتركة (Firestore)</h1>
        
        <!-- قسم 1: نموذج إضافة البيانات -->
        <section>
            <h2>إضافة ناخب جديد</h2>
            <form id="voterForm">
                <input type="text" id="voterName" placeholder="اسم الناخب الكامل" required>
                <input type="text" id="voterNationalId" placeholder="الرقم القومي (14 رقم إجباري)" pattern="[0-9]{14}" maxlength="14" required>
                <input type="text" id="voterCommitteeName" placeholder="اسم اللجنة (مثال: لجنة مدرسة الأمل)" required>
                <input type="text" id="voterCommitteeNumber" placeholder="رقم اللجنة (مثال: 005)" required>
                <button type="submit" style="flex: 1 1 100px;">إضافة سجل</button>
            </form>
            <p id="formMessage" class="message"></p>
        </section>
        
        <!-- قسم 2: جدول عرض البيانات والبحث الفوري -->
        <section id="searchSection">
            <h2>سجلات الناخبين (مزامنة فورية)</h2>
            <input type="text" id="searchField" placeholder="ابحث بالاسم أو الرقم القومي أو اللجنة..." oninput="filterAndRenderTable()" style="flex-basis: 350px;">
        </section>
        
        <table id="votersTable">
            <thead>
                <tr>
                    <th width="5%">م</th>
                    <th width="20%">اسم الناخب</th>
                    <th width="15%">الرقم القومي</th>
                    <th width="20%" class="hide-on-mobile">اسم اللجنة</th>
                    <th width="10%" class="hide-on-mobile">رقم اللجنة</th>
                    <th width="15%" class="hide-on-mobile">وقت الإنشاء</th>
                    <th width="15%">الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                <!-- السجلات هنا -->
            </tbody>
        </table>
    </div>

    <!-- ******************************************************************* -->
    <!-- منطق JavaScript واتصال Firebase -->
    <!-- ******************************************************************* -->
    <script type="module">
        // 1. استيراد المكتبات الضرورية
        import { initializeApp } from "https://www.gstatic.com/firebase/9/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebase/9/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebase/9/firebase-auth.js";
        
        // 2. إعدادات Firebase الثابتة
        const firebaseConfig = {
            // مفاتيحك التي تم تثبيتها لتجاوز مشكلة الاتصال
            apiKey: "AIzaSyD8oB5AVadAIj_rKEIhialPDZml1PhiJXM", 
            authDomain: "bayanatak-f8c09.firebaseapp.com",
            projectId: "bayanatak-f8c09", 
            // يمكن إضافة باقي الإعدادات هنا
        };
        
        const VOTERS_COLLECTION_NAME = 'voters';
        
        // 3. تهيئة Firebase وخدماتها
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let votersData = []; // لتخزين جميع البيانات محلياً
        
        // **********************************************
        // ********* الوظائف الرئيسية في الكود *********
        // **********************************************

        /**
         * دالة مساعدة لتنسيق وقت Firebase Timestamp إلى سلسلة نصية مقروءة.
         */
        function formatTimestamp(timestamp) {
            if (timestamp instanceof Timestamp) {
                const date = timestamp.toDate();
                return date.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
            return '---';
        }

        /**
         * initializeFirebase: تهيئة الاتصال والمصادقة المجهولة.
         */
        async function initializeFirebase() {
            try {
                await signInAnonymously(auth);
                console.info("تم تسجيل الدخول المجهول بنجاح.");
                setupRealtimeListener(); 
            } catch (error) {
                console.error("فشل في تهيئة Firebase أو المصادقة:", error);
                const msg = document.getElementById('formMessage');
                msg.innerText = "فشل الاتصال: تأكد من مفتاح API و Project ID وتفعيل المصادقة المجهولة.";
                msg.className = "message error";
            }
        }

        /**
         * setupRealtimeListener: الاستماع للتغييرات الفورية في Firestore.
         */
        function setupRealtimeListener() {
            const votersCol = collection(db, VOTERS_COLLECTION_NAME);
            onSnapshot(votersCol, (snapshot) => {
                // تحديث البيانات المحلية وفرزها بناءً على وقت الإنشاء (الأحدث أولاً)
                votersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                votersData.sort((a, b) => {
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA; // تنازلي (الأحدث أولاً)
                });
                
                filterAndRenderTable(); 
            }, (error) => {
                console.error("خطأ في الاستماع للبيانات:", error);
                const msg = document.getElementById('formMessage');
                msg.innerText = "توقف الاستماع للبيانات: لا يمكن الوصول إلى Firestore.";
                msg.className = "message error";
            });
        }
        
        /**
         * معالج نموذج الإضافة.
         */
        document.getElementById('voterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('voterName');
            const nationalIdInput = document.getElementById('voterNationalId');
            const committeeNameInput = document.getElementById('voterCommitteeName'); 
            const committeeNumberInput = document.getElementById('voterCommitteeNumber'); 
            
            const nationalId = nationalIdInput.value.trim();
            const name = nameInput.value.trim();
            const committeeName = committeeNameInput.value.trim(); 
            const committeeNumber = committeeNumberInput.value.trim(); 
            
            const messageElement = document.getElementById('formMessage');

            // التحقق من أن الرقم القومي مكون من 14 رقماً
            if (nationalId.length !== 14 || !/^\d{14}$/.test(nationalId)) {
                messageElement.innerText = "الرقم القومي يجب أن يكون 14 رقماً بالضبط.";
                messageElement.className = "message error";
                return;
            }

            try {
                // استخدام addDoc لإضافة سجل جديد مع الحقول الجديدة
                await addDoc(collection(db, VOTERS_COLLECTION_NAME), {
                    nationalId: nationalId,
                    name: name,
                    committeeName: committeeName, 
                    committeeNumber: committeeNumber, 
                    createdAt: Timestamp.now() 
                });
                
                messageElement.innerText = `تمت إضافة الناخب "${name}" بنجاح.`;
                messageElement.className = "message success";
                nameInput.value = '';
                nationalIdInput.value = '';
                committeeNameInput.value = ''; 
                committeeNumberInput.value = ''; 
                setTimeout(() => messageElement.innerText = '', 3000); 
            } catch (e) {
                console.error("خطأ في إضافة المستند: ", e);
                messageElement.innerText = "فشل الإضافة: " + e.message;
                messageElement.className = "message error";
            }
        });

        /**
         * filterAndRenderTable: تقوم بتصفية البيانات ثم تعرضها في الجدول.
         */
        window.filterAndRenderTable = function() {
            const tableBody = document.querySelector('#votersTable tbody');
            const searchTerm = document.getElementById('searchField').value.toLowerCase().trim();
            tableBody.innerHTML = ''; 
            
            // التصفية على البيانات المخزنة محلياً
            const filteredData = votersData.filter(voter => 
                voter.name?.toLowerCase().includes(searchTerm) || 
                voter.nationalId?.includes(searchTerm) ||
                voter.committeeName?.toLowerCase().includes(searchTerm) 
            );

            filteredData.forEach((voter, index) => {
                const row = tableBody.insertRow();
                row.setAttribute('data-id', voter.id); 
                
                // خلية التسلسل
                row.insertCell().textContent = index + 1;
                
                // خلية اسم الناخب
                const nameCell = row.insertCell();
                nameCell.textContent = voter.name || 'N/A';
                nameCell.className = 'name-cell';
                
                // خلية الرقم القومي
                const idCell = row.insertCell();
                idCell.textContent = voter.nationalId || 'N/A';
                idCell.className = 'national-id-cell';

                // خلية اسم اللجنة (جديد)
                const commNameCell = row.insertCell();
                commNameCell.textContent = voter.committeeName || 'N/A';
                commNameCell.className = 'committee-name-cell hide-on-mobile';

                // خلية رقم اللجنة (جديد)
                const commNumCell = row.insertCell();
                commNumCell.textContent = voter.committeeNumber || 'N/A';
                commNumCell.className = 'committee-number-cell hide-on-mobile';

                // خلية وقت الإنشاء
                const timeCell = row.insertCell();
                timeCell.textContent = formatTimestamp(voter.createdAt);
                timeCell.className = 'hide-on-mobile';
                
                // خلية الإجراءات
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button class="edit-btn" onclick="handleEdit('${voter.id}')">تعديل</button>
                    <button class="delete-btn" onclick="deleteVoter('${voter.id}')">حذف</button>
                `;
            });
        }
        
        /**
         * handleEdit: تحويل الصف إلى وضع التحرير.
         */
        window.handleEdit = function(docId) {
            const row = document.querySelector(`tr[data-id="${docId}"]`);
            if (!row) return;

            // تحديد الخلايا حسب ترتيبها الجديد: 1=الاسم, 2=الرقم القومي, 3=اسم اللجنة, 4=رقم اللجنة
            const cells = row.cells;
            const nameCell = cells[1];
            const idCell = cells[2];
            const commNameCell = cells[3];
            const commNumCell = cells[4];
            const timeCell = cells[5];
            const actionsCell = cells[6]; 

            // تخزين القيم القديمة
            const oldName = nameCell.textContent;
            const oldId = idCell.textContent;
            const oldCommName = commNameCell.textContent;
            const oldCommNum = commNumCell.textContent;

            // تحويل الخلايا إلى حقول إدخال
            nameCell.innerHTML = `<input type="text" id="edit-name-${docId}" value="${oldName}" class="editing-cell" style="width: 95%;">`;
            idCell.innerHTML = `<input type="text" id="edit-id-${docId}" value="${oldId}" pattern="[0-9]{14}" maxlength="14" class="editing-cell" style="width: 95%;">`;
            commNameCell.innerHTML = `<input type="text" id="edit-commName-${docId}" value="${oldCommName}" class="editing-cell" style="width: 95%;">`;
            commNumCell.innerHTML = `<input type="text" id="edit-commNum-${docId}" value="${oldCommNum}" class="editing-cell" style="width: 95%;">`;
            
            timeCell.innerHTML = `<span style="color: #9aa0a6;">(ثابت)</span>`;
            
            // تغيير أزرار الإجراءات
            actionsCell.innerHTML = `
                <button class="save-btn" onclick="saveVoterUpdate('${docId}')">حفظ</button>
                <button class="cancel-btn" onclick="filterAndRenderTable()">إلغاء</button>
            `;
        }
        
        /**
         * saveVoterUpdate: إرسال التعديلات إلى Firebase.
         */
        window.saveVoterUpdate = async function(docId) {
            const newName = document.getElementById(`edit-name-${docId}`).value.trim();
            const newId = document.getElementById(`edit-id-${docId}`).value.trim();
            const newCommName = document.getElementById(`edit-commName-${docId}`).value.trim(); 
            const newCommNum = document.getElementById(`edit-commNum-${docId}`).value.trim(); 
            
            if (newId.length !== 14 || !/^\d{14}$/.test(newId)) {
                alert("الرقم القومي يجب أن يكون 14 رقماً بالضبط.");
                return;
            }

            try {
                const voterRef = doc(db, VOTERS_COLLECTION_NAME, docId);
                // تحديث الحقول الجديدة والقديمة
                await updateDoc(voterRef, { 
                    name: newName, 
                    nationalId: newId,
                    committeeName: newCommName,
                    committeeNumber: newCommNum
                });
                
                // سيقوم onSnapshot بتحديث الجدول
            } catch (e) {
                console.error("خطأ في تحديث المستند: ", e);
                alert("فشل التحديث: " + e.message);
            }
        }

        /**
         * deleteVoter: وظيفة الحذف.
         */
        window.deleteVoter = async function(docId) {
            // ملاحظة: لا يجب استخدام alert/confirm في التطبيقات المعروضة داخل إطار (iframe)، ولكن نتركها هنا كتطبيق مباشر
            if (!confirm("تأكيد الحذف: هل أنت متأكد من حذف هذا السجل بشكل دائم؟")) return;

            try {
                const voterRef = doc(db, VOTERS_COLLECTION_NAME, docId);
                await deleteDoc(voterRef);
                // سيقوم onSnapshot بتحديث الجدول بعد الحذف
            } catch (e) {
                console.error("خطأ في حذف المستند: ", e);
                alert("فشل الحذف: " + e.message);
            }
        }

        // بدء تهيئة Firebase عند تحميل الصفحة
        initializeFirebase();

    </script>
</body>
</html>
