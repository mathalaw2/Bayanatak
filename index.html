<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>قاعدة بيانات الناخبين المشتركة</title>
    </head>
<body>
    <h1>إدارة قاعدة بيانات الناخبين (Firestore)</h1>
    
    <form id="voterForm">
        <input type="text" id="voterName" placeholder="اسم الناخب" required>
        <input type="text" id="voterNationalId" placeholder="الرقم القومي (14 رقم)" pattern="[0-9]{14}" required>
        <button type="submit">إضافة ناخب</button>
        <p id="formMessage" style="color: red;"></p>
    </form>
    
    <hr>
    
    <input type="text" id="searchField" placeholder="ابحث بالاسم أو الرقم القومي" oninput="filterAndRenderTable()">
    
    <h2>سجلات الناخبين:</h2>
    <table id="votersTable" border="1" width="100%">
        <thead>
            <tr>
                <th>الرقم القومي</th>
                <th>الاسم</th>
                <th>الإجراءات</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script type="module">
        // 1. استيراد المكتبات الضرورية
        import { initializeApp } from "https://www.gstatic.com/firebase/9/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebase/9/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebase/9/firebase-auth.js";
        
        // 2. إعدادات Firebase الثابتة
        // **********************************************
        // ** تأكد من استبدال المفاتيح ببيانات مشروعك الفعلية **
        // **********************************************
        const firebaseConfig = {
            apiKey: "AIzaSyD8oB5AVadAIj_rKEIhialPDZml1PhiJXM", // المفتاح الفعّال من دليلك
            authDomain: "bayanatak-f8c09.firebaseapp.com", // استبدل بمعرّف مشروعك
            projectId: "bayanatak-f8c09", // معرّف المشروع الخاص بك
            storageBucket: "bayanatak-f8c09.appspot.com", // استبدل بمعرّف مشروعك
            messagingSenderId: "...", // استبدل بالمعرّف الفعلي
            appId: "..." // استبدل بالمعرّف الفعلي
        };
        
        const VOTERS_COLLECTION_NAME = 'voters';
        
        // 3. تهيئة Firebase وخدماتها
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let votersData = []; // متغير لتخزين جميع بيانات الناخبين محليًا
        
        // **********************************************
        
        /**
         * دالة لتهيئة الاتصال بـ Firebase والمصادقة المجهولة.
         */
        async function initializeFirebase() {
            try {
                // تسجيل دخول المستخدم بشكل مجهول
                const userCredential = await signInAnonymously(auth);
                console.log("تم تسجيل الدخول بنجاح كـ:", userCredential.user.uid);
                
                // بدء المزامنة الفورية بمجرد المصادقة بنجاح
                setupRealtimeListener(); 
            } catch (error) {
                console.error("فشل في تهيئة Firebase أو المصادقة:", error);
                document.getElementById('formMessage').innerText = "فشل الاتصال بقاعدة البيانات. راجع الكونسول.";
            }
        }

        /**
         * تستمع إلى أي تغييرات في مجموعة 'voters' وتحدث الجدول تلقائياً.
         */
        function setupRealtimeListener() {
            const votersCol = collection(db, VOTERS_COLLECTION_NAME);
            onSnapshot(votersCol, (snapshot) => {
                votersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterAndRenderTable(); // عرض البيانات المحدثة
            }, (error) => {
                console.error("خطأ في الاستماع للبيانات:", error);
            });
        }
        
        /**
         * معالج نموذج الإضافة.
         */
        document.getElementById('voterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('voterName');
            const nationalIdInput = document.getElementById('voterNationalId');
            const nationalId = nationalIdInput.value.trim();
            const name = nameInput.value.trim();
            const messageElement = document.getElementById('formMessage');

            if (nationalId.length !== 14 || !/^\d{14}$/.test(nationalId)) {
                messageElement.innerText = "الرقم القومي يجب أن يكون 14 رقماً.";
                return;
            }

            try {
                // استخدام addDoc لإضافة سجل جديد
                await addDoc(collection(db, VOTERS_COLLECTION_NAME), {
                    nationalId: nationalId,
                    name: name,
                    createdAt: new Date() // إضافة وقت الإنشاء
                });
                
                messageElement.innerText = "تمت إضافة الناخب بنجاح.";
                nameInput.value = '';
                nationalIdInput.value = '';
                setTimeout(() => messageElement.innerText = '', 3000); // مسح الرسالة
            } catch (e) {
                console.error("خطأ في إضافة المستند: ", e);
                messageElement.innerText = "فشل الإضافة: " + e.message;
            }
        });

        /**
         * وظيفة عرض البيانات. تقوم بالتصفية ثم تعرضها في الجدول.
         */
        window.filterAndRenderTable = function() {
            const tableBody = document.querySelector('#votersTable tbody');
            const searchTerm = document.getElementById('searchField').value.toLowerCase().trim();
            tableBody.innerHTML = ''; // مسح الجدول القديم
            
            const filteredData = votersData.filter(voter => 
                voter.name.toLowerCase().includes(searchTerm) || 
                voter.nationalId.includes(searchTerm)
            );

            filteredData.forEach(voter => {
                const row = tableBody.insertRow();
                row.setAttribute('data-id', voter.id); // إضافة معرّف المستند لسهولة الإجراءات
                
                // خلية الرقم القومي
                const idCell = row.insertCell();
                idCell.textContent = voter.nationalId;
                idCell.className = 'national-id-cell';
                
                // خلية الاسم
                const nameCell = row.insertCell();
                nameCell.textContent = voter.name;
                nameCell.className = 'name-cell';
                
                // خلية الإجراءات
                const actionsCell = row.insertCell();
                actionsCell.innerHTML = `
                    <button onclick="handleEdit('${voter.id}')">تعديل</button>
                    <button onclick="deleteVoter('${voter.id}')">حذف</button>
                `;
            });
        }
        
        /**
         * تحويل الصف إلى وضع التحرير.
         */
        window.handleEdit = function(docId) {
            const row = document.querySelector(`tr[data-id="${docId}"]`);
            if (!row) return;

            const nameCell = row.querySelector('.name-cell');
            const nationalIdCell = row.querySelector('.national-id-cell');
            const actionsCell = row.cells[2];

            // تخزين القيم القديمة
            const oldName = nameCell.textContent;
            const oldId = nationalIdCell.textContent;

            // تحويل الخلايا إلى حقول إدخال
            nameCell.innerHTML = `<input type="text" id="edit-name-${docId}" value="${oldName}" required>`;
            nationalIdCell.innerHTML = `<input type="text" id="edit-id-${docId}" value="${oldId}" pattern="[0-9]{14}" required>`;
            
            // تغيير أزرار الإجراءات
            actionsCell.innerHTML = `
                <button onclick="saveVoterUpdate('${docId}')">حفظ</button>
                <button onclick="cancelEdit('${docId}', '${oldId}', '${oldName}')">إلغاء</button>
            `;
        }
        
        /**
         * إرسال التعديلات إلى Firebase.
         */
        window.saveVoterUpdate = async function(docId) {
            const newName = document.getElementById(`edit-name-${docId}`).value.trim();
            const newId = document.getElementById(`edit-id-${docId}`).value.trim();
            
            if (newId.length !== 14 || !/^\d{14}$/.test(newId)) {
                alert("الرقم القومي يجب أن يكون 14 رقماً.");
                return;
            }

            try {
                const voterRef = doc(db, VOTERS_COLLECTION_NAME, docId);
                // استخدام updateDoc لإرسال التعديلات
                await updateDoc(voterRef, {
                    name: newName,
                    nationalId: newId
                });
                
                // المزامنة الفورية ستتولى إعادة عرض البيانات وتحديث الصف
                alert("تم تحديث السجل بنجاح!"); 
            } catch (e) {
                console.error("خطأ في تحديث المستند: ", e);
                alert("فشل التحديث: " + e.message);
            }
        }

        /**
         * إلغاء التحرير واستعادة القيم القديمة.
         */
        window.cancelEdit = function(docId, oldId, oldName) {
            // إعادة تفعيل العرض التلقائي عبر إعادة تحميل البيانات من الذاكرة المحلية وعرضها
            filterAndRenderTable();
        }

        /**
         * وظيفة الحذف.
         */
        window.deleteVoter = async function(docId) {
            if (!confirm("هل أنت متأكد من حذف هذا السجل؟")) return;

            try {
                const voterRef = doc(db, VOTERS_COLLECTION_NAME, docId);
                // استخدام deleteDoc لإزالة السجل
                await deleteDoc(voterRef);
                
                // المزامنة الفورية ستتولى إزالة الصف من الجدول
                alert("تم حذف السجل بنجاح!");
            } catch (e) {
                console.error("خطأ في حذف المستند: ", e);
                alert("فشل الحذف: " + e.message);
            }
        }

        // بدء تهيئة Firebase عند تحميل الصفحة
        initializeFirebase();

    </script>
</body>
</html>
